

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>扩展数据源 &mdash; rqalpha 2.0.x documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="rqalpha 2.0.x documentation" href="../index.html"/>
        <link rel="next" title="History" href="../history.html"/>
        <link rel="prev" title="扩展事件源" href="event_source.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> rqalpha
          

          
          </a>

          
            
            
              <div class="version">
                2.0.x
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速指引</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/overview.html">RQAlpha 介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/install.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/detail_install.html">详细环境搭建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/tutorial.html">10分钟学会 RQAlpha</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/examples.html">策略示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/virtual_machine.html">RQAlpha开箱即用虚拟机</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/config.html">参数配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/base_api.html">基础 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/extend_api.html">扩展 API</a></li>
</ul>
<p class="caption"><span class="caption-text">Development</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="make_contribute.html">如何贡献代码</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_concept.html">基本概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="mod.html">RQAlpha 扩展 - Mod</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_source.html">扩展事件源</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">扩展数据源</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id2">五十行代码接入 tushare 行情数据</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Extra</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../history.html">History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../todo.html">TODO</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">rqalpha</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>扩展数据源</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/development/data_source.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="development-data-source">
<span id="id1"></span><h1>扩展数据源<a class="headerlink" href="#development-data-source" title="Permalink to this headline">¶</a></h1>
<p>RQAlpha 支持自定义扩展数据源。得益于 RQAlpha 的 mod 机制，我们可以很方便的替换或者扩展默认的数据接口。</p>
<p>RQAlpha 将提供给用户的数据 API 和回测所需的基础数据抽象成了若干个函数，这些函数被封于 <code class="xref py py-class docutils literal"><span class="pre">DataSource</span></code> 类中，并将在需要的时候被调用。简单的说，我们只需要在自己定义的 mod 中扩展或重写默认的 <code class="xref py py-class docutils literal"><span class="pre">DataSource</span></code> 类，就可以替换掉默认的数据源，接入自有数据。</p>
<p><code class="xref py py-class docutils literal"><span class="pre">DataSource</span></code> 类的完整文档，请参阅 <a class="reference internal" href="basic_concept.html#development-basic-concept"><span class="std std-ref">基本概念</span></a>。下面将用一个简单的例子，为大家介绍如何用五十行左右的代码将默认的行情数据替换为 <a class="reference external" href="http://tushare.org">TuShare</a> 的行情数据。</p>
<div class="section" id="id2">
<h2>五十行代码接入 tushare 行情数据<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>TushareKDataMod 的作用是使用 tushare 提供的k线数据替换 data_bundle 中的行情数据，由于目前 tushare 仅仅开放了日线、周线和月线的历史数据，所以该 mod 仍然只能提供日回测的功能，若未来 tushare 开放了60分钟或5分钟线的历史数据，只需进行简单修改，便可通过该 mod 使 RQAlpha 实现5分钟回测。</p>
<p>开工前，首先熟悉一下用到的 tushare 的k线接口，接口如下：</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="n">get_k_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">ktype</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">autype</span><span class="o">=</span><span class="s1">&#39;qfq&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>如上文所说，我们要做的主要就是扩展或重写默认的 DataSource 类。在此处，我们选择建立一个新的 DataSource 类，该类继承于默认的 <code class="xref py py-class docutils literal"><span class="pre">BaseDataSource</span></code> 类。</p>
<p>这样做的好处在于我们不必重写 DataSource 需要实现的所有函数，而可以只实现与我们想替换的数据源相关的函数，其他数据的获取直接甩锅给父类 <code class="xref py py-class docutils literal"><span class="pre">BaseDataSource</span></code> 。</p>
<p>与行情数据密切相关的主要有以下三个函数：</p>
<ul class="simple">
<li><code class="code docutils literal"><span class="pre">current_snapshot(instrument,</span> <span class="pre">frequency,</span> <span class="pre">dt)</span></code></li>
<li><code class="code docutils literal"><span class="pre">get_bar(instrument,</span> <span class="pre">dt,</span> <span class="pre">frequency)</span></code></li>
<li><code class="code docutils literal"><span class="pre">history_bars(instrument,</span> <span class="pre">bar_count,</span> <span class="pre">frequency,</span> <span class="pre">fields,</span> <span class="pre">dt,</span> <span class="pre">skip_suspended=True)</span></code></li>
<li><code class="code docutils literal"><span class="pre">available_data_range(frequency)</span></code></li>
</ul>
<p>经过查看 <code class="xref py py-class docutils literal"><span class="pre">DataProxy</span></code> 类的源代码，可以发现，提供日级别数据的 DataSource 类不需要实现 <code class="code docutils literal"><span class="pre">current_snapshot</span></code> 函数，所以我们只关注后三个函数的实现。</p>
<p><code class="code docutils literal"><span class="pre">get_bar</span></code> 和 <code class="code docutils literal"><span class="pre">history_bars</span></code> 函数实现的主要功能都是传入 instrument 对象，从 tushare 获取指定时间或时间段的 bar 数据。我们把这一过程抽象为一个函数:</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TushareKDataSource</span><span class="p">(</span><span class="n">BaseDataSource</span><span class="p">):</span>

<span class="o">...</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">):</span>

    <span class="c1"># 首先获取 order_book_id 并将其转换为 tushare 所能识别的 code</span>
    <span class="n">order_book_id</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">order_book_id</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">order_book_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># tushare 行情数据目前仅支持股票和指数，并通过 index 参数进行区分</span>
    <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;CS&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">instrument</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;INDX&#39;</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># 调用 tushare 函数，注意 datetime 需要转为指定格式的 str</span>
    <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_k_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>现在实现 <code class="code docutils literal"><span class="pre">get_bar</span></code> 函数：</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TushareKDataSource</span><span class="p">(</span><span class="n">BaseDataSource</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">get_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>

        <span class="c1"># tushare k线数据暂时只能支持日级别的回测，其他情况甩锅给默认数据源</span>
        <span class="k">if</span> <span class="n">frequency</span> <span class="o">!=</span> <span class="s1">&#39;1d&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

        <span class="c1"># 调用上边写好的函数获取k线数据</span>
        <span class="n">bar_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="c1"># 遇到获取不到数据的情况，同样甩锅；若有返回值，注意转换格式。</span>
        <span class="k">if</span> <span class="n">bar_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>
</div>
<p>然后是硬骨头 <code class="code docutils literal"><span class="pre">history_bars</span></code> 函数：</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TushareKDataSource</span><span class="p">(</span><span class="n">BaseDataSource</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">history_bars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">skip_suspended</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># tushare 的k线数据未对停牌日期做补齐，所以遇到不跳过停牌日期的情况我们先甩锅。有兴趣的开发者欢迎提交代码补齐停牌日数据。</span>
        <span class="k">if</span> <span class="n">frequency</span> <span class="o">!=</span> <span class="s1">&#39;1d&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_suspended</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">history_bars</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">skip_suspended</span><span class="p">)</span>

        <span class="c1"># 参数只提供了截止日期和天数，我们需要自己找到开始日期</span>
        <span class="c1"># 获取交易日列表，并拿到截止日期在列表中的索引，之后再算出开始日期的索引</span>
        <span class="n">start_dt_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trading_calendar</span><span class="p">()</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">bar_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># 根据索引拿到开始日期</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trading_calendar</span><span class="p">()[</span><span class="n">start_dt_loc</span><span class="p">]</span>

        <span class="c1"># 调用上边写好的函数获取k线数据</span>
        <span class="n">bar_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bar_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># 注意传入的 fields 参数可能会有不同的数据类型</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">]</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="c1"># 这样转换格式会导致返回值的格式与默认 DataSource 中该方法的返回值格式略有不同。欢迎有兴趣的开发者提交代码进行修改。</span>
            <span class="k">return</span> <span class="n">bar_data</span><span class="p">[</span><span class="n">fields</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</pre></div>
</div>
<p>最后是 <code class="code docutils literal"><span class="pre">available_data_range</span></code> 函数</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TushareKDataSource</span><span class="p">(</span><span class="n">BaseDataSource</span><span class="p">):</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">available_data_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>把以上几个函数组合起来，并加入构造函数，就完成了我们重写的 DataSource 类。完整代码如下：</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">tushare</span> <span class="k">as</span> <span class="nn">ts</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="k">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">rqalpha.data.base_data_source</span> <span class="k">import</span> <span class="n">BaseDataSource</span>


<span class="k">class</span> <span class="nc">TushareKDataSource</span><span class="p">(</span><span class="n">BaseDataSource</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">end_dt</span><span class="p">):</span>
        <span class="n">order_book_id</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">order_book_id</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">order_book_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">instrument</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;CS&#39;</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">instrument</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;INDX&#39;</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">ts</span><span class="o">.</span><span class="n">get_k_data</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">end_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_bar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frequency</span> <span class="o">!=</span> <span class="s1">&#39;1d&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

        <span class="n">bar_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bar_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">history_bars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">skip_suspended</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">frequency</span> <span class="o">!=</span> <span class="s1">&#39;1d&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">skip_suspended</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">history_bars</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">bar_count</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">skip_suspended</span><span class="p">)</span>

        <span class="n">start_dt_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trading_calendar</span><span class="p">()</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span> <span class="o">-</span> <span class="n">bar_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trading_calendar</span><span class="p">()[</span><span class="n">start_dt_loc</span><span class="p">]</span>

        <span class="n">bar_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tushare_k_data</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">start_dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bar_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_bar</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">]</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">bar_data</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">bar_data</span><span class="p">[</span><span class="n">fields</span><span class="p">]</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">available_data_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>到目前为止，我们的主要工作已经完成了。想要将我们刚刚写好的 DataSource 类投入使用，还需要将其放入一个 mod 来被 RQAlpha 加载。</p>
<p>mod 的实现如下：</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rqalpha.interface</span> <span class="k">import</span> <span class="n">AbstractMod</span>

<span class="kn">from</span> <span class="nn">.data_source</span> <span class="k">import</span> <span class="n">TushareKDataSource</span>


<span class="k">class</span> <span class="nc">TushareKDataMode</span><span class="p">(</span><span class="n">AbstractMod</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">mod_config</span><span class="p">):</span>
        <span class="c1"># 设置 data_source 为 TushareKDataSource 类的对象</span>
        <span class="n">env</span><span class="o">.</span><span class="n">set_data_source</span><span class="p">(</span><span class="n">TushareKDataSource</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">data_bundle_path</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">tear_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>最后的最后，添加 <code class="code docutils literal"><span class="pre">load_mod</span></code> 函数，该函数将被 RQAlpha 调用以加载我们刚刚写好的 mod 。</p>
<div class="highlight-python3"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">.mod</span> <span class="k">import</span> <span class="n">TushareKDataMode</span>


<span class="k">def</span> <span class="nf">load_mod</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TushareKDataMode</span><span class="p">()</span>
</pre></div>
</div>
<p>至此，我们已经完成了外部行情数据的接入，剩下要做的就是在 RQAlpha 启动时传入的配置信息中开启以上 mod。</p>
<p>该 mod 只是一个简单的 demo，仍存在一些问题，例如调用 tushare 接口速度较慢，频繁调用会消耗大量时间。如能将多次调用合并，或是将接口的调用改为异步，相信能够大幅提升回测速度。</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../history.html" class="btn btn-neutral float-right" title="History" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="event_source.html" class="btn btn-neutral" title="扩展事件源" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, RiceQuant.
      Last updated on Mar 27, 2017.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'2.0.x',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 
<script type="text/javascript">
    console.log("RQAlpha Powered By RiceQuant.");
</script>


</body>
</html>